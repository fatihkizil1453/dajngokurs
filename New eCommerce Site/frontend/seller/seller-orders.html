<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Yönetimi - MarketPlus</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <div class="flex items-center gap-4">
                <a href="../buyer/index.html" class="logo">MarketPlus</a>
                <span class="badge badge-pending">Satıcı Paneli</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm font-semibold">TechWorld Inc.</span>
                <div
                    style="width: 32px; height: 32px; background: var(--secondary); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                    TW</div>
            </div>
        </div>
    </nav>

    <div class="container flex" style="align-items: flex-start;">
        <!-- Sidebar -->
        <aside class="sidebar w-64 flex-shrink-0">
            <nav class="flex flex-col gap-1">
                <a href="seller-products.html" class="sidebar-link">Ürünler</a>
                <a href="seller-orders.html" class="sidebar-link active">Siparişler <span
                        class="badge badge-danger ml-auto" id="orderBadge">0</span></a>
                <a href="seller-messages.html" class="sidebar-link">Mesajlar</a>
                <a href="seller-dashboard.html" class="sidebar-link">Analitik</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <h1 class="font-bold text-2xl mb-6">Sipariş Yönetimi</h1>

            <div class="bg-white rounded shadow-sm border p-4">
                <!-- Tabs -->
                <div class="flex gap-4 border-b mb-4">
                    <button class="pb-2 border-b-2 border-primary font-semibold text-primary">Yeni Siparişler
                        (3)</button>
                    <button class="pb-2 text-muted hover:text-main">Hazırlanıyor (5)</button>
                    <button class="pb-2 text-muted hover:text-main">Kargolandı (12)</button>
                    <button class="pb-2 text-muted hover:text-main">İadeler (1)</button>
                </div>

                <!-- Order List -->
                <div class="flex flex-col gap-4" id="orderList">
                    <div class="text-center text-muted p-8">Siparişler yükleniyor...</div>
                </div>
            </div>
        </main>
    </div>
    <script src="../auth.js"></script>
    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let currentUser = null;
        let allOrders = [];
        let currentTab = 'WAITING';

        async function loadOrders() {
            currentUser = auth.getUser();
            if (!currentUser || currentUser.role !== 'SELLER') {
                window.location.href = '../buyer/login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/orders/seller/`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.access}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch orders');

                allOrders = await response.json();

                // Update badge
                const waitingCount = allOrders.filter(o => o.status === 'WAITING').length;
                document.getElementById('orderBadge').textContent = waitingCount;

                renderOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orderList').innerHTML = '<div class="text-center text-danger p-8">Siparişler yüklenirken hata oluştu</div>';
            }
        }

        function renderOrders() {
            const filtered = allOrders.filter(o => {
                if (currentTab === 'WAITING') return o.status === 'WAITING';
                if (currentTab === 'PROCESSING') return o.status === 'PROCESSING';
                if (currentTab === 'SHIPPED') return o.status === 'SHIPPED';
                if (currentTab === 'RETURNED') return o.status === 'RETURNED';
                return false;
            });

            const orderList = document.getElementById('orderList');

            if (filtered.length === 0) {
                orderList.innerHTML = '<div class="text-center text-muted p-8">Bu kategoride sipariş bulunmuyor</div>';
                return;
            }

            orderList.innerHTML = filtered.map(order => {
                const statusMap = {
                    'WAITING': { text: 'Onay Bekliyor', class: 'badge-pending' },
                    'PROCESSING': { text: 'Hazırlanıyor', class: 'badge-pending' },
                    'SHIPPED': { text: 'Kargolandı', class: 'badge-success' },
                    'DELIVERED': { text: 'Teslim Edildi', class: 'badge-success' },
                    'CANCELLED': { text: 'İptal', class: 'badge-danger' },
                    'RETURNED': { text: 'İade', class: 'badge-danger' }
                };
                const status = statusMap[order.status] || { text: order.status, class: 'badge-pending' };
                const date = new Date(order.created_at).toLocaleString('tr-TR');

                const itemsHtml = order.items.map(item => `
                    <tr>
                        <td class="w-12">
                            <div style="width: 30px; height: 30px; background: #eee;"></div>
                        </td>
                        <td>${item.variant_name || 'Ürün'}</td>
                        <td class="text-center">x${item.quantity}</td>
                        <td class="text-right">${parseFloat(item.total_price).toFixed(2)} TL</td>
                    </tr>
                `).join('');

                const buyerName = order.buyer_name || 'Müşteri';
                const shippingAddr = order.shipping_address;
                const addressText = shippingAddr ? `${shippingAddr.address || ''}, ${shippingAddr.city || ''}` : 'Adres bilgisi yok';

                const actionButton = order.status === 'WAITING'
                    ? `<div class="flex gap-2">
                         <button class="btn btn-primary btn-sm" onclick="processOrder(${order.id})">Siparişi İşle</button>
                         <button class="btn btn-secondary btn-sm" style="color:red;border-color:red;" onclick="rejectOrder(${order.id})">Reddet</button>
                       </div>`
                    : `<span class="badge ${status.class}">${status.text}</span>`;

                return `
                    <div class="border rounded p-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <span class="font-bold text-lg">Sipariş #${order.id}</span>
                                <span class="text-xs text-muted ml-2">${date}</span>
                            </div>
                            ${actionButton}
                        </div>
                        <div class="grid-cols-2 text-sm mb-4">
                            <div>
                                <div class="text-muted">Müşteri:</div>
                                <div class="font-semibold">${buyerName}</div>
                                <div>${addressText}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-muted">Toplam:</div>
                                <div class="font-semibold text-lg">${parseFloat(order.total_amount).toFixed(2)} TL</div>
                                <div class="text-success text-xs">Ödendi</div>
                            </div>
                        </div>
                        <div class="bg-white p-2 border rounded">
                            <table class="w-full text-sm">
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function processOrder(orderId) {
            if (!confirm('Bu siparişi onaylayıp hazırlamaya başlamak istiyor musunuz?')) {
                return;
            }

            try {
                // Update order status to PROCESSING
                const response = await fetch(`${API_BASE}/orders/seller/${orderId}/confirm/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.access}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Sipariş işlenemedi');
                }

                alert('Sipariş onaylandı ve müşteriye bildirim gönderildi!');

                // Reload orders
                await loadOrders();
            } catch (error) {
                console.error('Error processing order:', error);
                alert('Sipariş işlenirken hata oluştu: ' + error.message);
            }
        }

        async function rejectOrder(orderId) {
            if (!confirm('Bu siparişi REDDETMEK istediğinize emin misiniz?')) {
                return;
            }

            try {
                // Update order status to CANCELLED (Rejected)
                const response = await fetch(`${API_BASE}/orders/seller/${orderId}/reject/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.access}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Sipariş reddedilemedi');
                }

                alert('Sipariş reddedildi ve müşteriye bildirim gönderildi.');

                // Reload orders
                await loadOrders();
            } catch (error) {
                console.error('Error rejecting order:', error);
                alert('Sipariş reddedilirken hata oluştu: ' + error.message);
            }
        }

        function switchTab(tab) {
            currentTab = tab;

            // Update tab UI
            document.querySelectorAll('.flex.gap-4.border-b button').forEach(btn => {
                btn.className = 'pb-2 text-muted hover:text-main';
            });
            event.target.className = 'pb-2 border-b-2 border-primary font-semibold text-primary';

            renderOrders();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();

            // Setup tab buttons
            const tabContainer = document.querySelector('.flex.gap-4.border-b');
            tabContainer.innerHTML = `
                <button class="pb-2 border-b-2 border-primary font-semibold text-primary" onclick="switchTab('WAITING')">Yeni Siparişler (<span id="waitingCount">0</span>)</button>
                <button class="pb-2 text-muted hover:text-main" onclick="switchTab('PROCESSING')">Hazırlanıyor (<span id="processingCount">0</span>)</button>
                <button class="pb-2 text-muted hover:text-main" onclick="switchTab('SHIPPED')">Kargolandı (<span id="shippedCount">0</span>)</button>
                <button class="pb-2 text-muted hover:text-main" onclick="switchTab('RETURNED')">İadeler (<span id="returnedCount">0</span>)</button>
            `;

            // Update counts
            setInterval(() => {
                if (allOrders.length > 0) {
                    document.getElementById('waitingCount').textContent = allOrders.filter(o => o.status === 'WAITING').length;
                    document.getElementById('processingCount').textContent = allOrders.filter(o => o.status === 'PROCESSING').length;
                    document.getElementById('shippedCount').textContent = allOrders.filter(o => o.status === 'SHIPPED').length;
                    document.getElementById('returnedCount').textContent = allOrders.filter(o => o.status === 'RETURNED').length;
                }
            }, 100);
        });
    </script>
</body>

</html>